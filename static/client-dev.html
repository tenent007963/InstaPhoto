<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta name="viewport" content="initial-scale=1.5,maximum-scale=3,user-scalable=no"/>
    <title>InstantPhoto - Client</title>
    <link rel="icon" href="./favicon">
    <script src="/socket.io/socket.io.js"></script>
	<script src="/compressor.js"></script>
	<script src="./jquery.js"></script>
	<script src="./html5-qrcode.min.js"></script>
	<link rel="stylesheet" href="./bootstrap.css">
	<script src="./bootstrap.js"></script>
	<style>
	html,body {
    height: 100%;
	}
	body {
		background: #9796f0;  /* fallback for old browsers */
		background: -webkit-linear-gradient(to right, #fbc7d4, #9796f0);  /* Chrome 10-25, Safari 5.1-6 */
		background: linear-gradient(to bottom, #fbc7d4, #9796f0) no-repeat ; /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
		margin:0;
	}
	
	.container {
	margin-top: 10%;
	}
	
	.custom-file-label {
    text-align: left;
	font-size: xx-small;
	}
	
	.refresh-btn {
	color: #887272;
	transition: all 0.5s;
    text-align: center;
}
.refresh-btn::before {
	content: '';
	position: absolute;
	top: 0;
	left: 0;
	z-index: 1;
	background-color: rgba(255,255,255,0.3);
	transition: all 0.3s;
}
.refresh-btn:hover::before {
	opacity: 0 ;
	transform: scale(0.5,0.5);
}
.refresh-btn::after {
	content: '';
	position: absolute;
	top: 0;
	left: 0;
	z-index: 1;
	opacity: 0;
	transition: all 0.3s;
	border: 1px solid rgba(255,255,255,0.7);
	transform: scale(1.2,1.2);
}
.refresh-btn:hover::after {
	opacity: 1;
	transform: scale(1,1);
}

.save-btn {
	float:left;
	width: 100px;
}

.footer {
		bottom: 10px;
		right: 10px;
		position: absolute;
	}
	</style>
  </head>
  
  <body>
	<header>
		<div class="refresh-page">
			<div class="btn refresh-btn" onclick="window.location.reload();" id="refresh">
				<span>Reload Page</span>
			</div>
		</div>
	</header>
  
    <!-- File input -->
	<div class="container" id="container">
		
		<div class="row-fluid align-items-center justify-content-start">
			<div class="col">
				<h4 id="croom">Status: <span id="roomindicator">Offline</span></h4>
				<h4 id="status">Waiting to join room...</h4>
			</div>
		</div>	
		<div class="row-fluid align-items-center justify-content-start">
			<div class="col">
				<form class="md-form" id="holder" name="upload">
					<div class="custom-file mb-3">
						<input type="file" class="custom-file-input" id="input1" name="fresh" accept="image/*" capture="camera" autofocus>
						<label class="custom-file-label" for="input1">Open Camera</label>
					</div>
					<div class="custom-file mb-3">
						<input type="file" class="custom-file-input" id="input2" name="gallery" accept="image/*">
						<label class="custom-file-label" for="input2">Gallery Upload</label>
					</div>
				</form> 
				<button type="button" class="button save-btn" id="savefile" onclick="savefile()">Save File</button>
			</div>
		</div>
	</div>
	
	<!-- Popup for connecting room -->
	<div class="modal fade" id="popup" tabindex="-1" role="dialog" aria-labelledby="joinroom-popup" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="joinroom-title">Join A Room</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form>
						<h3>Enter room code:</h3>
						<input type="text" name="roomCode" id="roomCode" placeholder="Code here"/>
					</form>
						<div id="reader"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" onclick="getRoom()">Join</button>
				</div>
			</div>
		</div>
	</div>
	
	</body>
	
	<footer>
		<div class="footer" id="joinroom-button">
			<button type="button" class="btn btn-light" data-toggle="modal" data-target="#popup">Join Room</button>
		</div>
	</footer>
	
    <!-- Client Code -->
    <script type="text/javascript">
	//Debug section
	let isDebug = ( !!window.location.href.match(/dev/g) );
	  
      // Get WebSocket
      let socket = io();

      // Get DOM elements
      let _src1 = document.getElementById("input1");
	  let _src2 = document.getElementById("input2");
	  let _status = document.getElementById("status");
	  let _fileform = document.getElementById("holder");
	  let _container = document.getElementById("container");
	  let _roomCodeInput = document.getElementById("roomCode");

      // Join a channel
	  /* Debug code
      let room = "test";
	  let rm = "0";
	  socket.emit("join", room);
	   */
	  var room;

		// Listen to Source1 and Source2 input events
		[_src1,_src2].forEach(function(sauce){ 
			sauce.addEventListener("change", function (event) {

				// Prepeare file reader
				const file = event.target.files[0];
				if (!file) {
					return;
				}
				var fileReader = new FileReader();
		
				// Determine input type 
				if (file instanceof Blob) {
					// Check for file size (in kb)
					fileSize = (file.size / 1024).toFixed(3);
					// Add line for compressing image data here
					new Compressor(file, {
						quality: 0.6,
						checkOrientation: false,
						success(result) {
							// Read file
							fileReader.readAsDataURL(result);
						},
						error(err) {
						  _consoleLog(err.message);
						},
					});
				}
				fileReader.onloadend = function (event) {
					// Send an image event to the socket
					var image = event.target.result;
					// Check for connection status
					if (socket.connected) {
						emitPhoto(image);
						_consoleLog(`First try success!`);
					} else {
						// reconnect
						socket.connect();
						if (socket.connected) {
							emitPhoto(image);
							_consoleLog(`Second try success.`);
						} else { 
							alert("Connection lost! Will now refresh page.");
							_consoleLog(`Connection lost!`);
							window.location.reload();
							return false;
						}
					}
				};
			});
		});	
	
	function emitPhoto(image) {
		socket.emit("recvimage", image, room, (isSuccess) => {
			if (isSuccess) { _consoleLog('Image sent!') } else { emitPhoto(image)}
			});
	}
	
	function savefile() {
		socket.emit("status","save", room);
	}

	//Retrieving room code from input
	function getRoom() {
		let room = _roomCodeInput.value;
		joinroom(room);
	}


	//Join room
	function joinroom(rm) {
		if(room) {
			let oldroom = room;
			socket.emit("leave",oldroom);
		}
		room = rm;
		socket.emit("join",rm);
		checkStatus();
		$('#popup').modal('hide');
	 document.getElementById("roomindicator").innerHTML = "Online";
    }

    //Initialize QR Scanner
	function onScanSuccess(qrCodeMessage) {
		joinroom(qrCodeMessage);
		html5QrcodeScanner.clear();
		html5QrcodeScanner.stop().then(ignore => {
		// QR Code scanning is stopped.
		}).catch(err => {
		html5QrcodeScanner.stop();
		_consoleLog(err);
		});
	}

	function onScanFailure(error) {
		// handle scan failure, usually better to ignore and keep scanning
		_consoleLog(`QR error = ${error}`);
	}


	let html5QrcodeScanner = new Html5QrcodeScanner(
			"reader", { fps: 25 });
	html5QrcodeScanner.render(onScanSuccess, onScanFailure);

	//Check socket connection upon window.onfocus
	window.onfocus = () => {
		_consoleLog(`Window focused. Checking connection...`);
		if (!socket.connected) {
			_consoleLog(`Trying to reconnect...`);
			try { 
				socket.connect(); 
				if (!socket.connected) throw _consoleLog("Reconnect error!");
			}
			catch(err) {
				_consoleLog(`Reconnect failed! Will proceed to force reload.`);
				//alert(`${err} Will now force reload.`); //This code will cause page to lose focus and thus infinite loop
				_container.textContent = 'Socket disconnected! Will proceed to force reload.';
				window.location.reload();
			}
			
		} else {
			_consoleLog(`Client is connected, falling back.`);
			checkStatus();
			}
	}

	//AJAX Codes
	$(".custom-file-input").on("change", function() {
		var fileName = $(this).val().split("\\").pop();
		$(this).siblings(".custom-file-label").addClass("selected").html(fileName);
	});
	
	
	//Below are all socket functions / connections
	
	//Listen to "status" event and update _status element 
	socket.on("status",function(data){
		_consoleLog(`Received status update.`);
		_status.textContent = data;
		_fileform.reset();
	});
	
	// Upon socket disconnection
	socket.on('disconnect', function(){
	  // try to reconnect
	  socket.connect();
	  _consoleLog(`Trying to reconnect socket.`);
	});
	
	function checkStatus() {
		socket.emit("client","check",room, (serverIsOnline) => {
			if (serverIsOnline) { 
				_consoleLog(`Server side offline!`);
				_status.textContent = 'Server side offline!'; 
				_fileform.reset(); 
				} else {
				_consoleLog(`An error occurred.`);
				}
		});
		_consoleLog("Querying status..");
		if (isDebug) {
				window.document.title = "InstantPhoto - Client(Development)";
			  }
	}

	
	window.onload = () => {
		$('#popup').modal('show');
			}
			
	//Default debug Code, do not modify
	function _consoleLog(stringData) {
		if(isDebug) {
			console.log(stringData);
			} 
		}
    </script>
</html>
