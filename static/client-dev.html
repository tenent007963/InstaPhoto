<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
	<meta content="no-cache, no-store, must-revalidate" http-equiv="Cache-Control">
	<meta name="viewport" content="initial-scale=1.5,maximum-scale=3,user-scalable=no"/>
    <title>InstantPhoto - Client</title>
    <link rel="icon" href="./favicon">
    <script src="/socket.io/socket.io.js"></script>
	<script src="/compressor.js"></script>
	<script src="./jquery.js"></script>
	<script src="./html5-qrcode.min.js"></script>
	<link rel="stylesheet" href="./bootstrap.css">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/inter-ui@3.13.1/Inter%20(web)/Inter-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
	<script src="./bootstrap.js"></script>
    <!-- JS-Cookie -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
	<style>
	html,body {
    height: 100%;
	}
	body {
		background: #9796f0;  /* fallback for old browsers */
		background: -webkit-linear-gradient(to right, #fbc7d4, #9796f0);  /* Chrome 10-25, Safari 5.1-6 */
		background: linear-gradient(to bottom, #fbc7d4, #9796f0) no-repeat ; /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
		margin:0;
	}
	
	.container {
	margin-top: 10%;
	}
	
	.custom-file-label {
    text-align: left;
	font-size: xx-small;
	}
	
	.refresh-btn {
	color: #887272;
	transition: all 0.5s;
    text-align: center;
}
.refresh-btn::before {
	content: '';
	position: absolute;
	top: 0;
	left: 0;
	z-index: 1;
	background-color: rgba(255,255,255,0.3);
	transition: all 0.3s;
}
.refresh-btn:hover::before {
	opacity: 0 ;
	transform: scale(0.5,0.5);
}
.refresh-btn::after {
	content: '';
	position: absolute;
	top: 0;
	left: 0;
	z-index: 1;
	opacity: 0;
	transition: all 0.3s;
	border: 1px solid rgba(255,255,255,0.7);
	transform: scale(1.2,1.2);
}
.refresh-btn:hover::after {
	opacity: 1;
	transform: scale(1,1);
}

.save-btn {
	float:left;
	width: 100px;
}

.footer {
		bottom: 10px;
		right: 10px;
		position: absolute;
	}

.offline {
	color: red;
}

.online {
	color: green;
}
	</style>
  </head>
  
  <body>
	<header>
		<div class="refresh-page">
			<div class="btn refresh-btn" onclick="window.location.reload();" id="refresh">
				<span>Reload Page</span>
			</div>
		</div>
	</header>
  
    <!-- File input -->
	<div class="container" id="container">
		
		<div class="row-fluid align-items-center justify-content-start">
			<div class="col">
				<h5 id="croom">Status: <span id="roomindicator" class="offline">&#x25cf; Offline</span></h5>
				<h5 id="status">Waiting to join room...</h5>
			</div>
		</div>	
		<div class="row-fluid align-items-center justify-content-start">
			<div class="col">
				<form class="md-form" id="holder" name="upload">
					<div class="custom-file mb-3">
						<input type="file" class="custom-file-input" id="input1" name="fresh" accept="image/*" capture="camera" autofocus>
						<label class="custom-file-label" for="input1">Open Camera</label>
					</div>
					<div class="custom-file mb-3">
						<input type="file" class="custom-file-input" id="input2" name="gallery" accept="image/*">
						<label class="custom-file-label" for="input2">Gallery Upload</label>
					</div>
				</form> 
				<button type="button" class="button save-btn" id="savefile" onclick="savefile()">Save File</button>
			</div>
		</div>
	</div>
	
	<!-- Popup for connecting room -->
	<div class="modal fade" id="popup" tabindex="-1" role="dialog" aria-labelledby="joinroom-popup" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="joinroom-title">Join A Room</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form action="#" onsubmit="return getRoom()">
						<span>Enter room code:</span>
						<input label="roomCode" type="text" name="roomCode" id="roomCode" placeholder="Code here" style="width:65%"/>
					</form>
					<p></p>
						<div id="reader"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" onclick="getRoom()">Join</button>
				</div>
			</div>
		</div>
	</div>
	
	</body>
	
	<footer>
		<div class="footer" id="joinroom-button">
			<button type="button" class="btn btn-light" data-toggle="modal" data-target="#popup">Join Room</button>
		</div>
	</footer>
	
    <!-- Client Code -->
    <script type="text/javascript">
	//Debug section
	let isDebug = ( !!window.location.href.match(/dev/g) );
	  
      // Get WebSocket
      let socket = io();

      // Get DOM elements
      let _src1 = document.getElementById("input1");
	  let _src2 = document.getElementById("input2");
	  let _status = document.getElementById("status");
	  let _fileform = document.getElementById("holder");
	  let _container = document.getElementById("container");
	  let _roomCodeInput = document.getElementById("roomCode");
	  let _roomIndicator = document.getElementById("roomindicator");

      // Join a channel
	  /* Debug code
      let room = "test";
	  let rm = "0";
	  socket.emit("join", room);
	   */
	  let room;
	  let cameraId;

		// Listen to Source1 and Source2 input events
		[_src1,_src2].forEach(function(sauce){ 
			sauce.addEventListener("change", function (event) {

				// Prepare file reader
				const file = event.target.files[0];
				if (!file) {
					return;
				}
				const fileReader = new FileReader();
		
				// Determine input type 
				if (file instanceof Blob) {
					// Check for file size (in kb)
					fileSize = (file.size / 1024).toFixed(3);
					// Add line for compressing image data here
					new Compressor(file, {
						quality: 0.6,
						checkOrientation: false,
						success(result) {
							// Read file
							fileReader.readAsDataURL(result);
						},
						error(err) {
						  _consoleLog(err.message);
						},
					});
				}
				fileReader.onloadend = function (event) {
					// Send an image event to the socket
					let image = event.target.result;
					// Check for connection status
					if (socket.connected) {
						emitPhoto(image);
						_consoleLog(`First try success!`);
					} else {
						// reconnect
						socket.connect(); //method1
						socket.emit("join",room);
						if (socket.connected) {
							emitPhoto(image);
							_consoleLog(`Second try success.`);
						} else { 
							alert("Connection lost! Will now refresh page.");
							_consoleLog(`Connection lost!`);
							window.location.reload();
							return false;
						}
					}
				};
			});
		});	
	
	function emitPhoto(image) {
		socket.emit("recvimage", image, room, (isSuccess) => {
			if (isSuccess) { _consoleLog('Image sent!') } else { emitPhoto(image)}
			});
	}
	
	function savefile() {
		socket.emit("status","save", room);
	}

	//Retrieving room code from input
	function getRoom() {
		let str = _roomCodeInput.value;
		joinroom(str);
	}

	//Join room
	function joinroom(rm) {
		if(rm === undefined) {
			_status.textContent = 'Error: No room code!';
			_consoleLog(`Error: No room code!`);
			$('#popup').modal('show');
			return false;
		}
		if(socket.connected && room) {
			leaveroom(room);
		}
		Cookies.set('room',rm,{ expires: 31 ,path: ''});
		room = rm;
		socket.emit("join",rm);
		checkStatus();
		$('#popup').modal('hide');
    }

    //Leave room
    function leaveroom(rm){
		socket.emit("leave",rm);
		setOffline();
		_status.textContent = 'Disconnected from room ' + rm + '.';
	}

    //Initialize QR Scanner
	function onScanSuccess(qrCodeMessage) {
		joinroom(qrCodeMessage);
		html5Qrcode.clear().then(ignore => {
		// QR Code scanning is stopped.
		}).catch(err => {
		html5Qrcode.stop();
		_consoleLog(err);
		});
	}

	function onScanFailure(error) {
		// handle scan failure, usually better to ignore and keep scanning
		_consoleLog(`QR error = ${error}`);
	}

	let setOnline = () => {
		_roomIndicator.innerHTML = "&#x25cf; Online";
		_roomIndicator.className = "online";
	}

	let setOffline = () => {
		_roomIndicator.innerHTML = "&#x25cf; Offline";
		_roomIndicator.className = "offline";
	}

	// This method will trigger user permissions
	Html5Qrcode.getCameras().then(devices => {
	/**
	* devices would be an array of objects of type:
	* { id: "id", label: "label" }
	*/
		if (devices && devices.length) {
			cameraId = devices[2].id;
		}
	}).catch(err => {
		_consoleLog(err)
	});
	
	const html5Qrcode = new Html5QrcodeScanner("reader", { fps: 30 });
	html5Qrcode.render(onScanSuccess, onScanFailure);

	//Check socket connection upon window.onfocus
	window.onfocus = () => {
		_consoleLog(`Window focused. Checking connection...`);
		if (!socket.connected) {
			_consoleLog(`Trying to reconnect...`);
			setOffline();
			try { 
				socket.connect();
				socket.emit("join",room);
				socket.on('connect_error',function(reason) {
					_status.textContent = reason;
					window.location.reload();
				});
				_consoleLog(`Client reconnected.`);
				checkStatus();
			}
			catch(err) {
				_consoleLog(`Reconnect failed! Will proceed to force reload.`);
				//alert(`${err} Will now force reload.`); //This code will cause page to lose focus and thus infinite loop
				_container.textContent = 'Socket disconnected! Will proceed to force reload.';
				window.location.reload();
			}
			
		} else {
			_consoleLog(`Client is connected, falling back.`);
			checkStatus();
			}
	}

	//AJAX Codes
	$(".custom-file-input").on("change", function() {
		let fileName = $(this).val().split("\\").pop();
		$(this).siblings(".custom-file-label").addClass("selected").html(fileName);
	});
	
	
	//Below are all socket functions / connections

	//Listen to "status" event and update _status element 
	socket.on("status",function(data){
		_consoleLog(`Received status update.`);
		_status.textContent = data;
		_fileform.reset();
		setOnline();
	});
	
	// Upon socket disconnection
	socket.on('disconnect', function(){
	  // try to reconnect
	  socket.connect();
	  socket.emit("join",room);
	  _consoleLog(`Trying to reconnect socket.`);
	  socket.on('connect_error',function(reason) {
		  setOffline();
		  _status.textContent = reason;
		  window.location.reload();
	  });
	});

	socket.on('reconnect_error',function(reason){
		setOffline();
		_status.textContent = reason;
		window.location.reload();
	})
	
	function checkStatus() {
		_consoleLog("Querying status..");
		socket.emit("client","check",room, (cb) => {
			let res = cb.serverIsOnline;
			_consoleLog(`Raw callback:${cb}, Data:${res}.`);
			if (res) {
				_consoleLog('Server side online!');
				setOnline();
				_fileform.reset();
				return true;
			} else if(!res){
				_consoleLog(`Server side offline!`);
				_status.textContent = 'Server side offline!';
				_fileform.reset();
				setOffline();
				return false;
			} else if(res === 'error') {
				_status.textContent = 'Incorrect room details.';
				_fileform.reset();
				_consoleLog(`Incorrect room details.`);
			} else {
				_status.textContent = 'An error occurred. Will proceed with force refresh.';
				window.location.reload();
				_consoleLog(`An error occurred.`);
			}

		});
	}

	window.onload = () => {
		if (isDebug) {
			window.document.title = "InstantPhoto - Client(Development)";
		}
		let getRoom = Cookies.get('room');
		if (!getRoom) {
			$('#popup').modal('show');
		} else {
			joinroom(getRoom);
			_consoleLog(`Joining old room, room code: ${getRoom}`)
		}
			}
			
	//Default debug Code, do not modify
	function _consoleLog(stringData) {
		if(isDebug) {
			console.log(stringData);
			//TODO: https://help.papertrailapp.com/kb/configuration/configuring-centralized-logging-from-javascript/
			} 
		}
    </script>
</html>
