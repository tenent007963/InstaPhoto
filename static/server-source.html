<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>InstantPhoto - Server</title>
    <link rel="icon" href="./favicon">
    <script src="/socket.io/socket.io.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.js"></script>
	<script src="/compressor.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap" rel="stylesheet">
    <!-- Bundle: Easiest to use, supports all browsers -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@2.5.0/dist/pptxgen.bundle.js"></script>
	<style>
	@keyframes rainbow { 
    0%{background-position:0% 50%}
    50%{background-position:100% 25%}
    100%{background-position:0% 50%}
	}
	
	html, body, body div, span, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, abbr, address, cite, code, del, dfn, em, img, ins, kbd, q, samp, small, strong, sub, sup, var, b, i, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, figure, footer, header, hgroup, menu, nav, section, time, mark, audio, video {
    margin: 0;
    padding: 0;
    border: 0;
    outline: 0;
	font-size: 100%;
    vertical-align: baseline;
	}
	
	html {
		height: 100%;
	}
	
	body {
		background: #2BC0E4;  /* fallback for old browsers */
		background: -webkit-linear-gradient(to right, #2BC0E4, #EAECC6);  /* Chrome 10-25, Safari 5.1-6 */
		background: linear-gradient(to right, #2BC0E4, #EAECC6); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
		margin:0;
	}
	
	header h1 {
		margin:0 2px;
		font-family: 'Roboto', sans-serif;
		position: absolute;
		background-image: repeating-linear-gradient(45deg, violet, indigo, blue, green, yellow, orange, red, violet);
		text-align: left;
		background-size: 800% 800%;
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		font-size: 35px;
		animation: rainbow 20s infinite
	}
	
	h1 {
		font-size: x-large;
	}
	
	.init {
		z-index: 99;
		height: 100%
		width: 100%;
		margin:0; 
		padding:0; 
		top: 50%;
		align-content: center;
		text: center;
	}
	
	.container {
		width: 100%;
		height: 100%;
	}
	
	#topbar {
		width: 99%;
		overflow: hidden;
		padding: 10px 5px;
		background-color: #45b3a9; 
		display:flex;
		flex-direction: row-reverse;
		justify-content: flex-start;
		align-content: flex-start;
		}
	
	button {
		min-width: 120px;
		min-height: 35px;
		margin: 0 3px;
		position: relative;
		border: 3px solid white;
		justify-content: center;
		align-items: center;
		background: transparent;
		cursor: pointer;
		transition: .3s;
		color: white;
	}
	button:hover {
		box-shadow: 0px 0px 15px 5px #fff;
	}
	
	.preview {
		position:relative; 
		width: 280px; 
		height: 70vh;
		float: right;
		overflow: auto;
	}
	
	.savepptx {
		font-size:1.5rem;
		border:2px solid black;
		border-radius:100px;
		width:40px;
		height:40px;
		padding:5px;
		margin: 10% auto;
		transition: .5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
	}
	
	.latency {
		bottom: 0;
		right: 3px;
		position: absolute;
	}
	
	#header {
		width: 90%;
		margin:0 8px;
	}
	</style>
  </head>
  <body>
  <header>
  <h1>InstantPhoto<h1>
  </header>
  <div class="init" id="init">
  <button type="button" onclick="checkRoomInitialize();" id="init-button">Click here to start!</button>
  </div>
  
    <!-- Container -->
	<div class="container" id="main">
		<div class="topbar" id="topbar">
			<div class="btn-container" id="btn-container" style="display:none">
				<button type="button" id="clrtmb" onclick="rmtmb()">Clear Thumbnail</button>
				<button type="button" id="changeroom" onclick="joinroom()">Change Room</button>
			</div>
		<button type="button" id="moreopt" onclick="moreopt()">Expand</button>
		<button type="button" id="saveimage" onclick="saveimage()">Save Image : <span id="wannasavemou">Yes</span></button>
		<button type="button" id="togglepptx" onclick="togglepptx()">Create PPTX : <span id="pptxgenjsstatus">Off</span></button>
		<button type="button" id="savepptx" onclick="savepptx()" disabled>Save PPTX</button>
		<form style="float: right;position: relative" action="#" onsubmit="return false;">
		<input type="file" id="e-warranty" style="display:none !important;"/>
		<input type="text" name="GSPN" id="GSPNint" placeholder="S/O number:" disabled="disabled"/>	
		</form>
		<span id="ewanstat" style="position: relative;color: green;display:none">&#10004; E-Warranty Attached &#10004; </span>
	</div>
	<div class="header" id="header"> 
		<h1>Waiting input on client side...</h1>
		<br />
		<h3>Current room: <span id="roomindicator"></span></h3>
		<br />
	</div>
	<!-- Image output -->
	<img style="max-width:640px; max-height:480px;" src="" id="download"/>
	
	<!-- Preview sidebar -->
	<div class="preview" id="rightbar">
	
	</div>
	
	<p class="latency" id="socketlatency">Getting Latency...</p>
</div>
</body>

<footer>
<div class="warnings" style="color: red"> 
<span id="pptxnotenabled" style="display:none">Warning : PPTX not enabled!</span>
<br />
<span id="nosaveimage" style="display:none">Notice : Image not downloaded!</span>
</div>
</footer>
<!-- Client Code -->
    <script type="text/javascript">	  
	  //Debug section
	  var isDebug = ( window.location.href.match(/dev/g) ? true : false );
	  
	  //Define all document elements
	  const _svppt = document.getElementById("savepptx");
	  const _gpint = document.getElementById("GSPNint");
	  const _pptstat = document.getElementById("pptxgenjsstatus");
	  const _togppt = document.getElementById("togglepptx"); //no longer in use
	  const _pptxne = document.getElementById("pptxnotenabled");
	  const _fileInput = document.getElementById("e-warranty");
	  const _imgdown = document.getElementById("wannasavemou");
	  const _nsi = document.getElementById("nosaveimage");
	  const _ewanatt = document.getElementById("ewanstat");
	  const _btncoint = document.getElementById("btn-container");
	  const _moreopt = document.getElementById("moreopt");
	  const _latency = document.getElementById("socketlatency");
	  const _tmbdiv = document.getElementById("rightbar");
	
	  //Initialize elements status
	  var pptxenabled = false;
	  var saveimg = true;
	  var optenb = false;
	  var photocount = 0;
	  var latencycount = 0;

	  //Enable PPTXGenJS...or not?
	  function togglepptx() {
		if (pptxenabled) {
	      _pptstat.innerHTML = "Off";
	      pptxenabled = false;
	      _svppt.disabled = true;
		  _gpint.value = "";
	      _gpint.disabled = true;
		  _fileInput.value = "";
		  _fileInput.disabled = true;
		  _ewanatt.style.display = "none";
		  photocount = 0;
		  rmtmb();
		  socket.emit("status",`PptxGenJS not enabled!`,room);
		  _consoleLog(`PptxGenJS disabled.`);
	    } else {
		  window.pptx = new PptxGenJS();
	      pptxenabled = true;
	      _svppt.disabled = false;
	      _gpint.disabled = false;
		  _fileInput.disabled = false;
	      _pptxne.style.display = "none";
	      _pptstat.innerHTML = "On";
		  socket.emit("status",`Now adding photo ${photocount+1}`,room);
		  _consoleLog(`PptxGenJS enabled, waiting photo.`);
		}
	  }

	  // Get WebSocket
	  var socket = io();

	  // Get DOM elements
	  var output = document.getElementById("download");

	  // Join default channel "test"
	  var room = "test";
	  var rn = "0";
	  socket.emit("join", room);

	  // new "transimage" socket - w/o room param 
	  socket.on("transimage", function(image) {
		  _consoleLog(`Image received, processing.`);
	      output.src = image;
	      //Download image if enabled
		  if (saveimg == true) { 
	          download(image, smartFilename(), "application/octet-stream;base64");
		  } else {
		      _nsi.style.display = "block"
			  }
	      if (pptxenabled == true) {
		      window.slide = pptx.addNewSlide();
			  // Creating anonymous async func to check img orientation
			  // checking was done by outer func
			  orientCheck(image).then(rotated_image => {
			    _consoleLog(`Response: ${rotated_image}`);
				triggerthumbnail(rotated_image);
				slide.addImage({ data: rotated_image, x: 0, y: 0, w: 9.5, h: 5.5});
			  });
	      } else {
	          _pptxne.style.display = "block";
	      }
	  });
	  
	  //Newer filename function to determine filename
	  function smartFilename() {
		let filename = _gpint.value;
	    if (filename) {
			return filename.trim();
		} else {
			var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
			var stringLength = 10;
			function pickRandom() {	return possible[Math.floor(Math.random() * possible.length)]; }
			var randomString = Array.apply(null, Array(stringLength)).map(pickRandom).join('');
			return randomString;
		}
	  }

	  //Joining Different Room
	  function joinroom() {
	  let oldroom = room;

	      rn++;

	switch (rn) {
	  case 1:
       room = "room1";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 2: 
	   room = "room2";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 3:
	   room = "room3";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 4: 
	   room = "room4";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 5: 
	   room = "room5";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 6: 
	   room = "room6";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 7:
	   alert("You have hit the end of available rooms! Page will now refresh.");
	   location.reload();
	   break;
	  default:
	   room = "test";
		break;
		}

	      document.getElementById("roomindicator").innerHTML = room;

	  }
		
	  // Room initializing, check if all variable is correct
	  function checkRoomInitialize() {
	      if (rn == 0) {
			  // checking all variables and setup room
	          var isHiddenOrNot = document.getElementById("init");
			  isHiddenOrNot.style.display = "none";
			  var showTheContent = document.getElementById("main");
	          showTheContent.style.display = "block";
	          document.getElementById("roomindicator").innerHTML = room;
			  //check isDebug environment
			  if (isDebug) {
				window.document.title = "InstantPhoto - Server(Development)";
			  }
			  // tell host that server in room is online
			  socket.emit("server","isOnline",room);
			  _consoleLog(`Server ready.`);
	      } else {
	          location.reload();
	      };
	  }
		
	  //Save PPTX as file and reset all to default
	  function savepptx() {
	    if (_gpint && _gpint.value) {
	      pptx.save(smartFilename());
	      _pptstat.innerHTML = "Off";
	      pptxenabled = false;
	      _svppt.disabled = true;
		  _gpint.value = "";
	      _gpint.disabled = true;
		  _fileInput.value = "";
		  _fileInput.disabled = true;
		  _ewanatt.style.display = "none";
		  photocount = 0;
		  socket.emit("status",`File saved. Please re-enable PPTXGenJS.`,room)
		  rmtmb();
		  _consoleLog(`PPT file saved. Status resetted.`);
	  } else {
	   alert("No GSPN Service Order number!");
	    }}

	//Toggle SaveImage On/Off
	function saveimage() {
         switch(saveimg) {
		   case true:
		     saveimg = false;
		     _imgdown.innerHTML = "No";
			 _nsi.style.display = "block";
			 _fileInput.disabled = true;
			 break;
		   case false:
             saveimg = true;
		     _imgdown.innerHTML = "Yes";
			 _nsi.style.display = "none";
			 _fileInput.disabled = false;
             break;
          }}	
	   
//generate thumbnail for current received image and show at sidebar
function triggerthumbnail(image){
	resizeImageToSpecificWidth(200, image, function(dat) {
		var tmbnail = document.createElement("img");
		tmbnail.src = dat;
		tmbnail.setAttribute('id', 'tmbtnb');
		_tmbdiv.appendChild(tmbnail);
		});
		setTimeout(function(){_tmbdiv.scrollTop = _tmbdiv.scrollHeight;},100);
		photocount++
		socket.emit("status",`Now adding photo ${photocount+1}`,room);
}

//Sub-function required for creating thumbnail
function resizeImageToSpecificWidth(max, imgur, cb) {
  var data;
  var img = new Image();
  img.onload = function() {
    if (img.width > max) {
		var oc = document.createElement('canvas'), octx = oc.getContext('2d');
        oc.width = img.width;
        oc.height = img.height;
        octx.drawImage(img, 0, 0);
        if( img.width > img.height) {
            oc.height = (img.height / img.width) * max;
            oc.width = max;
        } else {
            oc.width = (img.width / img.height) * max;
            oc.height = max;
        }
        octx.drawImage(oc, 0, 0, oc.width, oc.height);          
        octx.drawImage(img, 0, 0, oc.width, oc.height);
        data = oc.toDataURL();
    } else {
       data = oc.toDataURL();
    }
    cb(data);
    };
    img.src = imgur;
  }
  
// Function to rotate image through extra canvas
// Note: ES6 is required or else code will report error
// Reference: https://jsfiddle.net/tenent007963/sfta0725/1/
async function orientCheck(data) {
	return promise = new Promise(resolve => {
		_consoleLog(`Checking image orientation`);
        let img = new Image();
		img.crossOrigin="anonymous";
        img.src = data;     
        // Create a canvas object.
        let canvas = document.createElement("canvas");
        // Wait till the image is loaded.
        img.onload = function(){
			if (img.height > img.width) {
				_consoleLog(`Orientation incorrect, rotating`);
				rotateImage();
			} else {
				_consoleLog(`Orientation correct,exit now`);
				resolve(returnImg());
			}			
        }
        let rotateImage = () => {
            // Create canvas context.
            let ctx = canvas.getContext("2d");
            // Assign width and height.
            cw = img.height;
			ch = img.width;
			cx = 0;
			cy = img.height * (-1);
			
			canvas.setAttribute('width', cw);
			canvas.setAttribute('height', ch);
			ctx.rotate(90 * Math.PI / 180);
			ctx.drawImage(output, cx, cy);
			_consoleLog(`Image rotation complete.`);
			//return canvas.toDataURL("image/png");
			canvas.toBlob(function(blobData){ compressImg(blobData);});
        }
		
		let compressImg = (imgStream) => {
			var fileReader = new FileReader()
			new Compressor(imgStream, {
						quality: 0.6,
						checkOrientation: false,
						success(result) {
							// Read file
							fileReader.readAsDataURL(result);
						},
						error(err) {
						  _consoleLog(err.message);
						},
					});
			fileReader.onloadend = function (event) {
				resolve(event.target.result);
			}
		}
		
		let returnImg = () => {
			return data;
		}
    });
}

	//Listening to Hotkeys 
	window.addEventListener("keydown", function(event) {
		switch(event.key) { 
		case "Enter":
			_consoleLog(`Enter Key Pressed`);
			event.preventDefault();
			if (!pptxenabled) {
				_consoleLog('Nothing to do.Exit now.');
				return false; //return true to submit, false to do nothing
			} else {
				if (photocount >=2) {
					savepptx();
					_consoleLog(`Saving PPT file`);
				} else {
					_consoleLog('PptxGenJS enabled but not enough photos, assuming mispress.');
					return false; //return true to submit, false to do nothing
				}
			}
			break;
		case "x":
			if (!pptxenabled) {
				togglepptx();
				}
			break;
		case "X":
			if (!pptxenabled) {
				togglepptx();
				}
			break;
		case (event.ctrlKey && event.shiftKey && "X"):
			if (pptxenabled) {
				togglepptx();
				alert(`File discarded!`);
			}
			break;
		case '`':
			saveimage();
			break;
		default:
			_consoleLog(`${event.key}`);
			break;
		}
	});		

//rightbar (thumbnail) cleaning
function rmtmb() {
    var element = document.getElementById('rightbar');
    element.innerHTML = '';
}

function moreopt() {
	switch(optenb) {
		   case true:
		     optenb = false;
			 _btncoint.style.display = "none";
			 _moreopt.textContent = "Expand";
			 break;
		   case false:
             optenb = true;
			 _btncoint.style.display = "block";
			 _moreopt.textContent = "Collapse";
             break;
			 }
	}
   
   	window.addEventListener('paste', function(e) {
		clipboardData = e.clipboardData;
		_fileInput.files = clipboardData.files;
		var file = document.querySelector('input[type=file]').files[0];
		var reader =  new FileReader();
		pastedData = clipboardData.getData('Text');
		
	    if (pptxenabled) {
			_consoleLog(`Detecting input type`);	
			if (pastedData) {
				_consoleLog(`Detected input as text`);
				setTimeout(function(){ 
					if (_gpint.value === pastedData) { 
						return;
					} else {
						_gpint.value = pastedData;
						return; 
					}},100);
			} else if (file instanceof Blob) {
				_consoleLog(`Detected input as blob`);
				reader.readAsDataURL(file);
				reader.onloadend = function () {
					var ewanss = reader.result;
					window.slide = pptx.addNewSlide();
					slide.addImage({data: ewanss, x: 0.5, y: 0.3, w: 8.5, h: 5.5 });
					triggerthumbnail(ewanss);
					if (saveimg == true) { 
						download(ewanss, smartFilename(), "application/octet-stream;base64");
					}
				}
				_ewanatt.style.display = "block";
			} else {
				_consoleLog(`Unknown input type, aborting.`);
				reader.abort();
				} 
		} else if(saveimg) {
			if (file instanceof Blob) {
				reader.readAsDataURL(file);
				reader.onloadend = function () {
					var pastedImg = reader.result;
					download(pastedImg, smartFilename(), "application/octet-stream;base64");
				}
			} else {
			_consoleLog(`Unknown input type, aborting.`);
				reader.abort();
			}
		} else {
			alert("PPTXGenJS not enabled!");
		}
	});
  
  // Below are all socket functions / connections
 
  // Upon socket disconnection
	socket.on('disconnect', function(){
      // Save current active ppt with random hash and proceed page reload
	  if (pptxenabled && photocount >= 2) {
		pptx.save(smartFilename());
		};
	  window.location.reload();
	  _consoleLog(`Socket disconnected`);
	});
	
  	// Return server image status to client upon call
	socket.on("status",(data) => {
	  _consoleLog(`Received parsed request from host`)
      switch(data) { 
	  case "check":
		if (pptxenabled) {
			_consoleLog(`Sending status..`)
			socket.emit("status",`Now adding photo ${photocount+1}`,room);
			} else {
			_consoleLog(`Sending status..`)
			socket.emit("status",`PptxGenJS not enabled!`,room);
			}
		break;
	  case "save":
		if (pptxenabled) {
			savepptx();
		}
		break;
      default:
		_consoleLog(`Request dropped!`)
		return false;
		break;
	}
	});
	
	// Latency checking
	socket.on('pong', function(ping) {
		_latency.textContent = ping + 'ms';
		_consoleLog(`Received Pong: ${ping}`);
		//Prompt if latency over acceptable threshold
		if (ping >= 550) {
			latencycount++;
			if (latencycount >= 4) {
				_latency.style.color = "red";
			}
			if (latencycount >= 7) {
				alert('High latency detected, some functions might not working properly.');
			}
		}
		if (ping < 500) {
			latencycount = 0;
			_latency.style.color = "black";
		}
	});
	
	window.onload = checkRoomInitialize();
	
	
	//Default debug Code, do not modify
	function _consoleLog(stringData) {
		if(isDebug) {
			console.log(stringData);
			} 
		}
    </script>
</html>
