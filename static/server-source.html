<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>InstantPhoto - Server</title>
    <link rel="icon" href="./favicon">
    <script src="/socket.io/socket.io.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.js"></script>
    <!-- Bundle: Easiest to use, supports all browsers -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@2.5.0/dist/pptxgen.bundle.js"></script>
  </head>
  <body>
  <div class="container" id="init" style="margin:0 auto; padding:auto; top: 50%;align-content: center;text: center; width:100%;height:90%;">
  <button type="button" onclick="checkRoomInitialize();" id="init-button" style="width: 250px; height: 30px; position: relative;" >Click here to start!</button>
  </div>
  
    <!-- Container -->
	<div class="container" id="main" style="display:none;">
	<div class="btn-container" id="btn-container" style="display:none">
	<button type="button" id="clrtmb" onclick="rmtmb()" style="float: right;position: relative; width: 150px; height: 25px;">Clear Thumbnail</button>
	<button type="button" id="changeroom" onclick="joinroom()" style="float: right;position: relative; width: 110px; height: 25px;">Change Room</button>
	</div>
	<button type="button" id="moreopt" onclick="moreopt()" style="float: right;position: relative; width: 110px; height: 25px;">More Options</button>
	<button type="button" id="saveimage" onclick="saveimage()" style="float: right;position: relative; width: 130px; height: 25px;">Save Image : <span id="wannasavemou">Yes</span></button>
	<button type="button" id="togglepptx" onclick="togglepptx()" style="float: right;position: relative; width: 130px; height: 25px;">Create PPTX : <span id="pptxgenjsstatus">Off</span></button>
	<button type="button" id="savepptx" onclick="savepptx()" style="float: right;position: relative; width: 100px; height: 25px;" disabled>Save PPTX</button>
	<form style="float: right;position: relative">
	<input type="file" id="e-warranty" style="display:none !important;" disabled="disabled" />
	<input type="text" name="GSPN" id="GSPNint" placeholder="S/O number:" onkeypress="return formenter(event)" disabled="disabled"/>   
	</form>
	<span id="ewanstat" style="float: right;position: relative;color: green;display:none">&#10004; E-Warranty Attached &#10004; </span>
	<h3>Waiting input on client side...</h3>
	<h4>Current room: <span id="roomindicator"></span></h4>
    <br />
	<!-- Image output -->
	<img style="max-width:640px; max-height:480px;" src="" id="download"/>
	
	<!-- Preview sidebar -->
	<div id="rightbar" style="position:relative; width:240px; height: 720px;float:right">
	
	</div>
</div>
</body>

<footer>
<div class="warnings" style="color: red"> 
<span id="pptxnotenabled" style="display:none">Warning : PPTX not enabled!</span>
<br />
<span id="nosaveimage" style="display:none">Notice : Image not downloaded!</span>
</div>
</footer>
<!-- Client Code -->
    <script type="text/javascript">
	
	  //Define all document elements
	  const svppt = document.getElementById("savepptx");
	  const gpint = document.getElementById("GSPNint");
	  const pptstat = document.getElementById("pptxgenjsstatus");
	  const togppt = document.getElementById("togglepptx");
	  const pptxne = document.getElementById("pptxnotenabled");
	  const fileInput = document.getElementById("e-warranty");
	  const imgdown = document.getElementById("wannasavemou");
	  const nsi = document.getElementById("nosaveimage");
	  const ewanatt = document.getElementById("ewanstat");
	  const btncoint = document.getElementById("btn-container");
	
	  //Initialize elements status
	  let pptxenabled = false;
	  let saveimg = true;
	  let optenb = false;

	  //Enable PPTXGenJS...or not?
	  function togglepptx() {
	      window.pptx = new PptxGenJS();
	      pptxenabled = true;
	      svppt.disabled = false;
	      gpint.disabled = false;
		  fileInput.disabled = false;
	      pptxne.style.display = "none";
	      pptstat.innerHTML = "On";
	      togppt.disabled = true;
	  }

	  // Get WebSocket
	  var socket = io();

	  // Get DOM elements
	  var output = document.getElementById("download");

	  // Join default channel "test"
	  var room = "test";
	  var rn = "0";
	  socket.emit("join", room);

	  socket.on("image", function(image, woroom) {
	      var loggo = ["receiving data from", woroom];
		  console.log(loggo);
	      output.src = image;
		  triggerthumbnail(image);
	      //Download Image Automatically if want
		  if (saveimg == true) { 
	          download(image, filename(), "application/octet-stream;base64");
		  } else {
		      nsi.style.display = "block"
			  }
	      if (pptxenabled == true) {
		      window.slide = pptx.addNewSlide();
	          slide.addImage({ data: image, x: 0, y: 0, w: 9.5, h: 5.5});
	      } else {
	          pptxne.style.display = "block";
	      }
	  });

	  //Grab Filename from input field
	  function filename() {
	      let GSPNsonumber = gpint.value;
	      return GSPNsonumber;
	  }

	  //Joining Different Room
	  function joinroom() {
	  let oldroom = room;

	      rn++;

	switch (rn) {
	  case 1:
       room = "room1";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 2: 
	   room = "room2";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 3:
	   room = "room3";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 4: 
	   room = "room4";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 5: 
	   room = "room5";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 6: 
	   room = "room6";
	   socket.emit("leave", oldroom);
	   socket.emit("join", room);
	   break;
	  case 7:
	   alert("You have hit the end of available rooms! Page will now refresh.");
	   location.reload();
	   break;
	  default:
	   room = "test";
		break;
		}

	      document.getElementById("roomindicator").innerHTML = room;

	  }

	  function checkRoomInitialize() {
	      if (rn == 0) {
	          var isHiddenOrNot = document.getElementById("init");
			  isHiddenOrNot.style.display = "none";
			  var showTheContent = document.getElementById("main");
	          showTheContent.style.display = "block";
	          document.getElementById("roomindicator").innerHTML = room;
	      } else {
	          location.reload();
	      };
	  }

	  function savepptx() {
	    if (gpint && gpint.value) {
	      pptx.save(filename());
	      pptstat.innerHTML = "Off";
	      pptxenabled = false;
	      svppt.disabled = true;
		  gpint.value = "";
	      gpint.disabled = true;
	      togppt.disabled = false;
		  fileInput.value = "";
		  fileInput.disabled = true;
		  ewanatt.style.display = "none";
		  rmtmb();
	  } else {
	   alert("No GSPN Service Order number!");
	    }}

	function saveimage() {
         switch(saveimg) {
		   case true:
		     saveimg = false;
		     imgdown.innerHTML = "No";
			 nsi.style.display = "block";
			 break;
		   case false:
             saveimg = true;
		     imgdown.innerHTML = "Yes";
			 nsi.style.display = "none";
             break;
          }}	
		
	window.addEventListener('paste', function(e) {
	    if (pptxenabled == true) {
			clipboardData = e.clipboardData;
			pastedData = clipboardData.getData('Text');
			if (pastedData) {
				setTimeout(function(){ 
					if (gpint.value === pastedData) { 
						return;
					} else {
						gpint.value = pastedData;
						return; 
					}},100);
			} else {
				fileInput.files = clipboardData.files;
				var file = document.querySelector('input[type=file]').files[0];
				var reader =  new FileReader();
				reader.readAsDataURL(file);
				reader.onloadend = function () {
					var ewanss = reader.result;
					window.slide = pptx.addNewSlide();
					slide.addImage({data: ewanss, x: 0.5, y: 0.3, w: 8.5, h: 5.5 });
					triggerthumbnail(ewanss);
				}
				ewanatt.style.display = "block";
			}
		} else {
			alert("PPTXGenJS not enabled!")
		}
	});
	   
	   
	//generate thumbnail for current received image and show at sidebar

function triggerthumbnail(image){
	resizeImageToSpecificWidth(200, image, function(dat) {
		var tmbnail = document.createElement("img");
		tmbnail.src = dat;
		tmbnail.setAttribute('id', 'tmbtnb');
		var tmbdiv = document.getElementById("rightbar");
		tmbdiv.appendChild(tmbnail);
		});
}

function resizeImageToSpecificWidth(max, imgur, cb) {
  var data;
      var img = new Image();
      img.onload = function() {
        if (img.width > max) {
          var oc = document.createElement('canvas'), octx = oc.getContext('2d');
          oc.width = img.width;
          oc.height = img.height;
          octx.drawImage(img, 0, 0);
          if( img.width > img.height) {
            oc.height = (img.height / img.width) * max;
            oc.width = max;
          } else {
            oc.width = (img.width / img.height) * max;
            oc.height = max;
          }
          octx.drawImage(oc, 0, 0, oc.width, oc.height);          
          octx.drawImage(img, 0, 0, oc.width, oc.height);
          data = oc.toDataURL();
        } else {
          data = oc.toDataURL();
        }
        cb(data);
      };
      img.src = imgur;
  }
	
	   
  function formenter(e){
  e=e||window.event;
  var key = e.keyCode;
  if(key==13) //Enter
  {
     return false; //return true to submit, false to do nothing
  }
}

function rmtmb() {
    // Removes an element from the document
    var element = document.getElementById('rightbar');
    element.innerHTML = '';
}

function moreopt() {
	switch(optenb) {
		   case true:
		     optenb = false;
			 btncoint.style.display = "none";
			 break;
		   case false:
             optenb = true;
			 btncoint.style.display = "block";
             break;
			 }
	}
   

  window.onload = checkRoomInitialize();
    </script>
</html>
