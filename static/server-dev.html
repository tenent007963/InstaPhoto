<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
	<meta http-equiv="Cache-control" content="no-cache">
    <title>InstantPhoto - Server</title>
    <link rel="icon" href="./favicon">
    <script src="/socket.io/socket.io.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.js"></script>
	<script src="/compressor.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap" rel="stylesheet">
    <!-- Bundle: Easiest to use, supports all browsers -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@2.5.0/dist/pptxgen.bundle.js"></script>
	<!-- Qrcode-generator -->
	<script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.js"></script>
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
	<!-- Google Fonts -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
	<!-- Bootstrap dependencies -->
	<link rel="stylesheet" href="./bootstrap.css">
	<script src="./bootstrap.js"></script>
	<!-- Custom Style -->
	<style>
 @keyframes rainbow { 
    0%{background-position:0% 50%}
    50%{background-position:100% 25%}
    100%{background-position:0% 50%}
	}

	body {
		background: #2BC0E4;  /* fallback for old browsers */
		background: -webkit-linear-gradient(to right, #2BC0E4, #EAECC6);  /* Chrome 10-25, Safari 5.1-6 */
		background: linear-gradient(to right, #2BC0E4, #EAECC6); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
		margin:0;
	}
	
	header h1 {
		font-family: 'Roboto', sans-serif;
		background-image: repeating-linear-gradient(45deg, violet, indigo, blue, green, yellow, orange, red, violet);
		text-align: left;
		background-size: 800% 800%;
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		font-size: 35px;
		animation: rainbow 20s infinite;
		position: absolute;
		padding-left: 20px;
	}
	
	#topbar {
		width: 99%;
		overflow: hidden;
		padding: 10px 5px;
		background-color: #45b3a9; 
		display:flex;
		flex-direction: row-reverse;
		justify-content: flex-start;
		align-content: flex-start;
		flex-wrap:wrap;
		}

 #bottombar {
	 width: 99%;
	 overflow: hidden;
	 padding: 10px 5px;
	 background-color: #45b3a9;
	 display:flex;
	 flex-direction: row;
	 justify-content: flex-start;
	 align-content: flex-start;
	 flex-wrap:wrap;
 }
	
	.styledButton {
		min-width: 110px;
		min-height: 30px;
		margin: 0 1px;
		position: relative;
		border: 2px solid white;
		justify-content: center;
		align-items: center;
		background: transparent;
		cursor: pointer;
		transition: .3s;
		color: white;
	}
	.styledButton:hover {
		box-shadow: 0px 0px 15px 5px #fff;
	}
	
	.preview {
		position:relative; 
		width: 280px; 
		height: 70vh;
		float: right;
		overflow: auto;
	}
		
	.latency {
		bottom: 0;
		right: 10px;
		position: absolute;
	}
</style>
  </head>
  <body>
	<header>
		<h1>InstantPhoto</h1>
	</header>
	<div class="container" id="init">
		<h3>Select your role:</h3>
		<button type="button" onclick="initCS()" id="csMode">CSO</button>
		<button type="button" onclick="initTech()" id="techMode">Tech</button>
	</div>
  
    <!-- Container -->
	<div class="container-fluid" id="main">
		<div class="btn-toolbar topbar cs" role="toolbar" aria-label="Normal Usage Topbar" id="topbar">
			<button type="button" class="btn btn-light" data-toggle="modal" data-target="#popup">Room Details</button>
			<button type="button" class="btn btn-light mr-1" id="saveimage" onclick="saveimage()">Save Image : <span id="wannasavemou">No</span></button>
			<button type="button" class="btn btn-light mr-1" id="togglepptx" onclick="togglepptx()">Create PPTX : <span id="pptxgenjsstatus">Off</span></button>
			<button type="button" class="btn btn-light mr-1" id="savepptx" onclick="savepptx()" disabled>Save PPTX</button>
			<form style="float: right;position: relative" action="#" onsubmit="return false;">
			<input type="file" id="e-warranty" style="display:none !important;"/>
			<input type="text" name="GSPN" id="GSPNint" placeholder="S/O number:" disabled="disabled"/>	
			</form>
			<span id="ewanstat" style="position: relative;color: green;display:none">&#10004; E-Warranty Attached &#10004; </span>
		</div>
		<div class="head" id="top"> 
			<h5 id="head">Waiting input on client side...</h5>
		</div>
		<!-- Image output -->
		<img style="max-width:640px; max-height:480px;" src="" id="download"/>
	
		<!-- Preview sidebar -->
		<div class="preview" id="rightbar">
		</div>
	
		<p class="latency" id="socketlatency">Getting Latency...</p>
	</div>
	
	<div class="modal fade" id="popup" tabindex="-1" role="dialog" aria-labelledby="roomqr-popup" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="popup-title">Room details</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>Current room: <span id="roomindicator"></span></p>
					<p></p>
					<div id="roomqr"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="changeroom" onclick="refreshroom()">Change Room</button>
				</div>
			</div>
		</div>
	</div>

	<div class="warnings" style="color: red">
		<span id="pptxnotenabled" style="display:none">Warning : PPTX not enabled!</span>
		<br />
		<span id="nosaveimage" style="display:none">Notice : Image not downloaded!</span>
	</div>
</body>

<footer>
	<div class="btn-toolbar bottombar" role="toolbar" aria-label="Developer Bottombar" id="bottombar" style="display:none">
		<button type="button" class="btn btn-light mr-1" id="moreopt" onclick="moreopt()" style="display:none;">Expand</button>
		<div class="btn-container" id="btn-container" >
			<button type="button" class="btn btn-dark" id="clrtmb" onclick="rmtmb()">Clear Thumbnail</button>
			<button type="button" class="btn btn-dark" id="pinglog" onclick="_log(ping)"><span id="ping">Show</span> Ping Log</button>
			<button type="button" class="btn btn-dark" id="imgdatalog" onclick="_log(imgdata)"><span id="imgdata">Show</span> ImgData Log</button>
		</div>
	</div>
</footer>
<!-- Client Code -->
    <script type="text/javascript">	  
	  //Debug section
	  let isDebug = ( !!window.location.href.match(/dev/g) );
	  
	  //Define all document elements
	  const _svppt = document.getElementById("savepptx");
	  const _gpint = document.getElementById("GSPNint");
	  const _pptstat = document.getElementById("pptxgenjsstatus");
	  const _togppt = document.getElementById("togglepptx"); //no longer in use
	  const _pptxne = document.getElementById("pptxnotenabled");
	  const _fileInput = document.getElementById("e-warranty");
	  const _imgdown = document.getElementById("wannasavemou");
	  const _nsi = document.getElementById("nosaveimage");
	  const _ewanatt = document.getElementById("ewanstat");
	  const _btncoint = document.getElementById("btn-container");
	  const _moreopt = document.getElementById("moreopt");
	  const _latency = document.getElementById("socketlatency");
	  const _tmbdiv = document.getElementById("rightbar");
	  const _roomqr = document.getElementById("roomqr");
	  const _roomindicator = document.getElementById("roomindicator");
	  const _mainContainer = document.getElementById("main");
	  const _initContainer = document.getElementById("init");
	  const _header = document.getElementById("head");
	  const _ping = document.getElementById("ping");
	  const _imgdata = document.getElementById("imgdata")
	
	  //Initialize elements
	  var pptxenabled = false;
	  var saveimg = false;
	  var optenb = false;
	  var photocount = 0;
	  var latencycount = 0;
	  var room;
	  var logping = false;
	  var logimgdata = false;

	  //Enable PPTXGenJS...or not?
	  function togglepptx() {
		if (pptxenabled) {
	      _pptstat.innerHTML = "Off";
	      pptxenabled = false;
	      _svppt.disabled = true;
		  _gpint.value = "";
	      _gpint.disabled = true;
		  _fileInput.value = "";
		  _fileInput.disabled = true;
		  _ewanatt.style.display = "none";
		  photocount = 0;
		  rmtmb();
		  socket.emit("status",`PptxGenJS not enabled!`,room);
		  _consoleLog(`PptxGenJS disabled.`);
		  _header.innerHTML = "PptxGenJS disabled.";
	    } else {
		  window.pptx = new PptxGenJS();
	      pptxenabled = true;
	      _svppt.disabled = false;
	      _gpint.disabled = false;
		  _fileInput.disabled = false;
	      _pptxne.style.display = "none";
	      _pptstat.innerHTML = "On";
		  socket.emit("status",`Now adding photo ${photocount+1}`,room);
		  _consoleLog(`PptxGenJS enabled, waiting photo.`);
		  _header.innerHTML = "PptxGenJS enabled, waiting photo.";
		}
	  }

	  // Get WebSocket
	  var socket = io();

	  // Get DOM elements
	  var output = document.getElementById("download");

	  // new "transimage" socket - w/o room param 
	  socket.on("transimage", function(image) {
		  _consoleLog(`Image received, processing.`);
	      output.src = image;
	      //Download image if enabled
		  if (saveimg == true) { 
	          download(image, smartFilename(), "application/octet-stream;base64");
		  } else {
		      _nsi.style.display = "block"
			  }
	      if (pptxenabled == true) {
		      addSlide(image);
	      } else {
	          _pptxne.style.display = "block";
	      }
	  });
	  
	  //External Func for random string generating
	  function genRand(len) {
        var hash = "abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ12346789";
        var randomStr = '';
        for(var i = 0; i < len; i++){
            randomStr += hash[parseInt(Math.random()*hash.length)];
        }
        return randomStr;
	  } 
	  
	  //Newer filename function to determine filename
	  function smartFilename() {
		let filename = _gpint.value;
	    if (filename) {
			return filename.trim();
		} else {
			var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
			var stringLength = 10;
			function pickRandom() {	return possible[Math.floor(Math.random() * possible.length)]; }
			var randomString = Array.apply(null, Array(stringLength)).map(pickRandom).join('');
			return randomString;
		}
	  }

	async function genQR(data) {
		var qrcode = new QRCode("roomqr");
		qrcode.makeCode(data);
	}
	
		
	  //Refresh Room
	  function refreshroom() {
	    //Theres a bug here, the condition wont meet even room exist
		if(room) {
			let oldroom = room;
			socket.emit("leave", oldroom);
			}
	  
		room = genRand(10);
		
	  // Join default channel "test"
	  // for debug only
	  /*
	  var room = "test";
	  var rn = "0";
	  */
		
	    _roomindicator.innerHTML = room;
		_roomqr.innerHTML = "";
		genQR(room);
		socket.emit("join", room);
		socket.emit("server","isOnline",room);
	  }       
   
		
	  // Room initializing, check if all variable is correct
	  function checkRoomInitialize() {
		try {
			  //check isDebug environment
			  if (isDebug) {
				window.document.title = "InstantPhoto - Server(Development)";
			  }
			  //Run through necessary func
			  refreshroom();
			  //Display interface
			$('#popup').modal('show');
			  _initContainer.style.display = "none";
	          _mainContainer.style.display = "block";
			  _consoleLog(`Server ready.`);
			}
		catch (err) {
			_mainContainer.innerHTML = err.message;
			location.reload();
			}
	  }

	  //Whenever adding a new slide, image data will parse into this function
	  function addSlide(image) {
		  window.slide = pptx.addNewSlide();
		  // Creating anonymous async func to check img orientation
		  // checking was done by outer func
		  orientCheck(image).then(rotated_image => {
			  if(logimgdata) {
				  _consoleLog(`Response: ${rotated_image}`);
			  }
			  triggerthumbnail(rotated_image);
			  slide.addImage({ data: rotated_image, x: 0, y: 0, w: 10, h: 5.6});
			  _header.innerHTML = `Added Image #${photocount}.`;
		  });
	  }


	  //Save PPTX as file and reset all to default
	  function savepptx() {
	    if (_gpint && _gpint.value) {
	      pptx.save(smartFilename());
	      _pptstat.innerHTML = "Off";
	      pptxenabled = false;
	      _svppt.disabled = true;
		  _gpint.value = "";
	      _gpint.disabled = true;
		  _fileInput.value = "";
		  _fileInput.disabled = true;
		  _ewanatt.style.display = "none";
		  photocount = 0;
		  socket.emit("status",`File saved. Please re-enable PPTXGenJS.`,room)
		  rmtmb();
		  _consoleLog(`PPT file saved. Status resetted.`);
	  } else {
	   alert("No GSPN Service Order number!");
	    }}

	//Toggle SaveImage On/Off
	function saveimage() {
         switch(saveimg) {
		   case true:
		     saveimg = false;
		     _imgdown.innerHTML = "No";
			 _nsi.style.display = "block";
			 _fileInput.disabled = true;
			 break;
		   case false:
             saveimg = true;
		     _imgdown.innerHTML = "Yes";
			 _nsi.style.display = "none";
			 _fileInput.disabled = false;
             break;
          }}	
	   
//generate thumbnail for current received image and show at sidebar
function triggerthumbnail(image){
	resizeImageToSpecificWidth(200, image, function(dat) {
		var tmbnail = document.createElement("img");
		tmbnail.src = dat;
		tmbnail.setAttribute('id', 'tmbtnb');
		_tmbdiv.appendChild(tmbnail);
		});
		setTimeout(function(){_tmbdiv.scrollTop = _tmbdiv.scrollHeight;},100);
		photocount++
		socket.emit("status",`Now adding photo ${photocount+1}`,room);
}

//Sub-function required for creating thumbnail
function resizeImageToSpecificWidth(max, imgur, cb) {
  var data;
  var img = new Image();
  img.onload = function() {
    if (img.width > max) {
		var oc = document.createElement('canvas'), octx = oc.getContext('2d');
        oc.width = img.width;
        oc.height = img.height;
        octx.drawImage(img, 0, 0);
        if( img.width > img.height) {
            oc.height = (img.height / img.width) * max;
            oc.width = max;
        } else {
            oc.width = (img.width / img.height) * max;
            oc.height = max;
        }
        octx.drawImage(oc, 0, 0, oc.width, oc.height);          
        octx.drawImage(img, 0, 0, oc.width, oc.height);
        data = oc.toDataURL();
    } else {
       data = oc.toDataURL();
    }
    cb(data);
    };
    img.src = imgur;
  }
  
// Function to rotate image through extra canvas
// Note: ES6 is required or else code will report error
// Reference: https://jsfiddle.net/tenent007963/sfta0725/1/
async function orientCheck(data) {
	return promise = new Promise(resolve => {
		_consoleLog(`Checking image orientation`);
        let img = new Image();
		img.crossOrigin="anonymous";
        img.src = data;     
        // Create a canvas object.
        let canvas = document.createElement("canvas");
        // Wait till the image is loaded.
        img.onload = function(){
			if (img.height > img.width) {
				_consoleLog(`Orientation incorrect, rotating`);
				rotateImage();
			} else {
				_consoleLog(`Orientation correct,exit now`);
				resolve(returnImg());
			}			
        }
        let rotateImage = () => {
            // Create canvas context.
            let ctx = canvas.getContext("2d");
            // Assign width and height.
            cw = img.height;
			ch = img.width;
			cx = 0;
			cy = img.height * (-1);
			
			canvas.setAttribute('width', cw);
			canvas.setAttribute('height', ch);
			ctx.rotate(90 * Math.PI / 180);
			ctx.drawImage(output, cx, cy);
			_consoleLog(`Image rotation complete.`);
			//return canvas.toDataURL("image/png");
			canvas.toBlob(function(blobData){ compressImg(blobData);});
        }
		
		let compressImg = (imgStream) => {
			var fileReader = new FileReader()
			new Compressor(imgStream, {
						quality: 0.6,
						checkOrientation: false,
						success(result) {
							// Read file
							fileReader.readAsDataURL(result);
						},
						error(err) {
						  _consoleLog(err.message);
						},
					});
			fileReader.onloadend = function (event) {
				resolve(event.target.result);
			}
		}
		
		let returnImg = () => {
			return data;
		}
    });
}

	//Listening to Hotkeys 
	window.addEventListener("keydown", function(event) {
		switch(event.key) { 
		case "Enter":
			_consoleLog(`Enter Key Pressed`);
			event.preventDefault();
			if (!pptxenabled) {
				_consoleLog('Nothing to do.Exit now.');
				return false; //return true to submit, false to do nothing
			} else {
				if (photocount >=2) {
					savepptx();
					_consoleLog(`Saving PPT file`);
				} else {
					_consoleLog('PptxGenJS enabled but not enough photos, assuming mispress.');
					return false; //return true to submit, false to do nothing
				}
			}
			break;
		case "x" :
			if (!pptxenabled) {
				togglepptx();
				}
			break;
		case "X":
			if (!pptxenabled) {
				togglepptx();
				}
			break;
		case ( (event.ctrlKey && event.shiftKey && event.altKey) & "z" || "Z"  ):
			if (pptxenabled) {
				togglepptx();
				alert(`File discarded!`);
			}
			break;
		case '`':
			saveimage();
			break;
		default:
			_consoleLog(`${event.key}`);
			break;
		}
	});		


	  //Below are all functions that are used in dev mode

	  //rightbar (thumbnail) cleaning
	  function rmtmb() {
    	var element = document.getElementById('rightbar');
    	element.innerHTML = '';
	  }

	  //toggle more buttons
	  function moreopt() {
		switch(optenb) {
		   case true:
		     optenb = false;
			 _btncoint.style.display = "none";
			 _moreopt.textContent = "Expand";
			 break;
		   case false:
             optenb = true;
			 _btncoint.style.display = "block";
			 _moreopt.textContent = "Collapse";
             break;
			 }
	  }

	  //static function for enable/disable logging
	  function _log(option) {
	  	switch(option) {
	  		case "ping":
				if(!logping) {
					logping = false;
					_ping.textContent = "Show";
				} else {
					logping = true;
					_ping.textContent = "Hide";
				}
	  			break;
			case "imgdata":
				if(!logimgdata) {
					logimgdata = false;
					_imgdata.textContent = "Show";
				} else {
					logimgdata = true;
					_imgdata.textContent = "Show";
				}
				break;
			default:
				return false;
		}
	  }
   
   	window.addEventListener('paste', function(e) {
		clipboardData = e.clipboardData;
		_fileInput.files = clipboardData.files;
		var file = document.querySelector('input[type=file]').files[0];
		var reader =  new FileReader();
		pastedData = clipboardData.getData('Text');
		
	    if (pptxenabled) {
			_consoleLog(`Detecting input type`);	
			if (pastedData) {
				_consoleLog(`Detected input as text`);
				setTimeout(function(){ 
					if (_gpint.value === pastedData) { 
						return;
					} else {
						_gpint.value = pastedData;
						return; 
					}},100);
			} else if (file instanceof Blob) {
				_consoleLog(`Detected input as blob`);
				reader.readAsDataURL(file);
				reader.onloadend = function () {
					var ewanss = reader.result;
					addSlide(ewanss);
					if (saveimg == true) { 
						download(ewanss, smartFilename(), "application/octet-stream;base64");
					}
				}
				_ewanatt.style.display = "block";
			} else {
				_consoleLog(`Unknown input type, aborting.`);
				reader.abort();
				} 
		} else if(saveimg) {
			if (file instanceof Blob) {
				reader.readAsDataURL(file);
				reader.onloadend = function () {
					var pastedImg = reader.result;
					download(pastedImg, smartFilename(), "application/octet-stream;base64");
				}
			} else {
			_consoleLog(`Unknown input type, aborting.`);
				reader.abort();
			}
		} else {
			alert("PPTXGenJS not enabled!");
		}
	});
  
  // Below are all socket functions / connections
 
  // Upon socket disconnection
	socket.on('disconnect', function(){
      // Save current active ppt with random hash and proceed page reload
	  if (pptxenabled && photocount >= 2) {
		pptx.save(smartFilename());
		};
	  window.location.reload();
	  _consoleLog(`Socket disconnected`);
	});
	
  	// Return server image status to client upon call
	socket.on("status",(data) => {
	  _consoleLog(`Received parsed request from host`)
      switch(data) { 
	  case "check":
		  _consoleLog(`Sending status..`);
		  $('#popup').modal('hide');
		  if (pptxenabled) {
			socket.emit("status",`Now adding photo ${photocount+1}`,room);
			} else {
			socket.emit("status",`PptxGenJS not enabled!`,room);
			}
		break;
	  case "save":
		if (pptxenabled) {
			savepptx();
		}
		break;
      default:
		_consoleLog(`Request dropped!`);
		return false;
		break;
	}
	});
	
	// Latency checking
	socket.on('pong', function(ping) {
		_latency.textContent = ping + 'ms';
		if(logping) {
			_consoleLog(`Received Pong: ${ping}`);
		}
		socket.emit("server","isOnline",room);
		//Prompt if latency over acceptable threshold
		if (ping >= 550) {
			latencycount++;
			if (latencycount >= 4) {
				_latency.style.color = "red";
			}
			if (latencycount >= 7) {
				alert('High latency detected, some functions might not working properly.');
			}
		}
		if (ping < 500) {
			latencycount = 0;
			_latency.style.color = "black";
		}
	});
	
	window.onload = checkRoomInitialize();
	
	//Small cheat code to make sure heroku dyno doesn't go idling when user is connected
	  function httpGetAsync(theUrl, callback)
	  {
		  var xmlHttp = new XMLHttpRequest();
		  xmlHttp.onreadystatechange = function() {
			  if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
				  callback(xmlHttp.responseText);
		  }
		  xmlHttp.open("GET", theUrl, true); // true for asynchronous
		  xmlHttp.send(null);
	  }



	//Default debug Code, do not modify
	function _consoleLog(stringData) {
		if(isDebug) {
			console.log(stringData);
			} 
		}
    </script>
</html>
