<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>InstantPhoto - Server - Local</title>
    <script src="/socket.io/socket.io.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.js"></script>
    <!-- Bundle: Easiest to use, supports all browsers -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@2.5.0/dist/pptxgen.bundle.js"></script>
  </head>
  <body>
  <div class="container" id="init" style="margin:0 auto; padding:auto; top: 50%;align-content: center;text: center; width:100%;height:90%;">
  <button type="button" onclick="checkRoomInitialize();" id="init-button" style="width: 250px; height: 30px; position: relative;" >Click here to start!</button>
  </div>
  
    <!-- Image output -->
	<div class="container" id="main" style="display:none;">
	<button type="button" id="changeroom" onclick="joinroom()" style="float: right;position: relative; width: 110px; height: 25px;">Change Room</button>
	<button type="button" id="saveimage" onclick="saveimage()" style="float: right;position: relative; width: 130px; height: 25px;">Save Image : <span id="wannasavemou">Yes</span></button>
	<button type="button" id="togglepptx" onclick="togglepptx()" style="float: right;position: relative; width: 130px; height: 25px;">PPTXGenJS : <span id="pptxgenjsstatus">Off</span></button>
	<button type="button" id="savepptx" onclick="savepptx()" style="float: right;position: relative; width: 100px; height: 25px;" disabled>Save PPTX</button>
	<form style="float: right;position: relative">
	<input type="text" name="GSPN" id="GSPNint" placeholder="S/O number:" disabled="disabled"/>
	<input type="file" id="e-warranty" disabled="disabled" />
	</form>
	<h3>Waiting input on client side...</h3>
	<h4>Current room: <span id="roomindicator"></span></h4>
    <br />
	<img style="max-width:640px; max-height:480px;" src="" id="download"/>
</div>
</body>

<footer>
<div class="warnings" style="color: red"> 
<span id="pptxnotenabled" style="display:none">Warning : PPTX not enabled!</span>
<br />
<span id="nosaveimage" style="display:none">Notice : Image not saved!</span>
</div>
</footer>
<!-- Client Code -->
    <script type="text/javascript">
	
	  //Define all document elements
	  const svppt = document.getElementById("savepptx");
	  const gpint = document.getElementById("GSPNint");
	  const pptstat = document.getElementById("pptxgenjsstatus");
	  const togppt = document.getElementById("togglepptx");
	  const pptxne = document.getElementById("pptxnotenabled");
	  const fileInput = document.getElementById("e-warranty");
	  const imgdown = document.getElementById("wannasavemou");
	  const nsi = document.getElementById("nosaveimage");
	
	  //Initialize elements status
	  let pptxenabled = false;
	  let saveimg = false;

	  //Enable PPTXGenJS...or not?
	  function togglepptx() {
	      window.pptx = new PptxGenJS();
	      pptxenabled = true;
	      svppt.disabled = false;
	      gpint.disabled = false;
		  fileInput.disabled = false;
	      pptxne.style.display = "none";
	      pptstat.innerHTML = "On";
	      togppt.disabled = true;
	  }

	  // Get WebSocket
	  var socket = io();

	  // Get DOM elements
	  var output = document.getElementById("download");

	  // Join a channel
	  var room = "test";
	  var rn = "0";
	  socket.emit("join", room);

	  socket.on("image", function(image) {
	      output.src = image;
	      //Download Image Automatically if want
		  if (saveimg == true) { 
	          download(image, filename(), "application/octet-stream;base64");
		  } else {
		      nsi.style.display = "block"
			  }
	      if (pptxenabled == true) {
		      window.slide = pptx.addNewSlide();
	          slide.addImage({ data: image, x: 0, y: 0, w: 9.5, h: 5.5});
	      } else {
	          pptxne.style.display = "block";
	      }
	  });

	  //Grab Filename from input field
	  function filename() {
	      let GSPNsonumber = gpint.value;
	      return GSPNsonumber;
	  }

	  //Joining Different Room
	  function joinroom() {

	      var oldroom = room;
	      rn++;

	      switch (rn) {
	          case 1:
	              var room = "room1";
	              socket.emit("leave", oldroom);
	              socket.emit("join", room);
	              break;
	          case 2:
	              var room = "room2";
	              socket.emit("leave", oldroom);
	              socket.emit("join", room);
	              break;
	          case 3:
	              var room = "room3";
	              socket.emit("leave", oldroom);
	              socket.emit("join", room);
	              break;
	          case 4:
	              var room = "room4";
	              socket.emit("leave", oldroom);
	              socket.emit("join", room);
	              break;
	          case 5:
	              var room = "room5";
	              socket.emit("leave", oldroom);
	              socket.emit("join", room);
	              break;
	          case 6:
	              var room = "room6";
	              socket.emit("leave", oldroom);
	              socket.emit("join", room);
	              break;
	          case 7:
	              alert("You have hit the end of available rooms! Page will now refresh.");
	              location.reload();
	              break;
	          default:
	              var room = "test";
	              socket.emit("leave", oldroom);
	              socket.emit("join", room);
	              break;
	      }

	      document.getElementById("roomindicator").innerHTML = room;

	  }

	  function checkRoomInitialize() {
	      if (rn == 0) {
	          console.log(rn);
	      } else {
	          location.reload();
	      };
	      var isHiddenOrNot = document.getElementById("init");
	      isHiddenOrNot.style.display = "none";
	      var showTheContent = document.getElementById("main");
	      showTheContent.style.display = "block";
	      document.getElementById("roomindicator").innerHTML = room;
		  saveimg = true;
	  }

	  function savepptx() {
	    if (gpint && gpint.value) {
	      pptx.save(filename());
	      pptstat.innerHTML = "Off";
	      pptxenabled = false;
	      svppt.disabled = true;
		  gpint.value = "";
	      gpint.disabled = true;
	      togppt.disabled = false;
		  fileInput.value = "";
		  fileInput.disabled = true;
	  } else {
	   alert("No GSPN Service Order number!");
	    }}

	  function saveimage() {
         switch(saveimg) {
		   case true:
		     saveimg = false;
		     imgdown.innerHTML = "No";
			 nsi.style.display = "none";
			 break;
		   case false:
             saveimg = true;
		     imgdown.innerHTML = "Yes";
			 nsi.style.display = "block";
             break;
          }}	
		
	   window.addEventListener('paste', function(e) {
	   if (pptxenabled == true) {
	    fileInput.files = e.clipboardData.files;
		var file = document.querySelector('input[type=file]').files[0];
		var reader =  new FileReader();
		reader.readAsDataURL(file);
		reader.onloadend = function () {
		  var ewanss = reader.result;
		  window.slide = pptx.addNewSlide();
		  slide.addImage({data: ewanss, x: 0.5, y: 0.3, w: 8.5, h: 5.5 });
		}
	   } else {
	    alert("PPTXGenJS not enabled!")
	   }});
    </script>
</html>
